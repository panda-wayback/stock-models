# 仓位管理指南

## 概述

策略基类提供了灵活的仓位管理方法，支持：
1. 按现金比例买入
2. 按持仓比例卖出
3. 固定数量交易
4. 自动按最小交易单位（100股）取整

---

## 一、基本用法

### 1.1 按现金比例买入

```python
class MyStrategy(BaseStrategy):
    def next(self):
        # 使用50%的现金买入
        size = self.calculate_position_size(cash_ratio=0.5)
        if size > 0:
            self.buy(size=size)
        
        # 或使用便捷方法
        self.buy_with_ratio(cash_ratio=0.5)
```

### 1.2 按持仓比例卖出

```python
class MyStrategy(BaseStrategy):
    def next(self):
        # 卖出50%的持仓
        size = self.calculate_position_size(position_ratio=0.5)
        if size > 0:
            self.sell(size=size)
        
        # 或使用便捷方法
        self.sell_with_ratio(position_ratio=0.5)
```

### 1.3 固定数量交易

```python
class MyStrategy(BaseStrategy):
    def next(self):
        # 固定买入1000股
        size = self.calculate_position_size(fixed_size=1000)
        self.buy(size=size)
        
        # 或直接指定
        self.buy(size=1000)
```

---

## 二、详细方法说明

### 2.1 calculate_position_size()

计算交易数量的核心方法。

```python
def calculate_position_size(
    cash_ratio: float = 1.0,        # 现金比例（买入时）
    position_ratio: Optional[float] = None,  # 持仓比例（卖出时）
    fixed_size: Optional[int] = None,  # 固定数量
    min_size: int = 100              # 最小交易单位（默认100股）
) -> int:
```

**参数说明**：
- `cash_ratio`: 使用现金的比例（0.0-1.0）
  - `1.0` = 使用全部现金
  - `0.5` = 使用50%现金
  - `0.25` = 使用25%现金
- `position_ratio`: 使用持仓的比例（0.0-1.0）
  - `1.0` = 全部卖出
  - `0.5` = 卖出50%持仓
  - `0.25` = 卖出25%持仓
- `fixed_size`: 固定数量（股数），如果指定则优先使用
- `min_size`: 最小交易单位，默认100股（A股1手）

**返回值**：
- 计算后的数量（已按最小交易单位取整）

**示例**：
```python
# 使用50%现金买入
size = self.calculate_position_size(cash_ratio=0.5)
self.buy(size=size)

# 卖出30%持仓
size = self.calculate_position_size(position_ratio=0.3)
self.sell(size=size)

# 固定买入500股
size = self.calculate_position_size(fixed_size=500)
self.buy(size=size)
```

### 2.2 buy_with_ratio()

按现金比例买入的便捷方法。

```python
def buy_with_ratio(cash_ratio: float = 1.0, **kwargs):
```

**示例**：
```python
# 使用50%现金买入
self.buy_with_ratio(cash_ratio=0.5)

# 使用全部现金买入
self.buy_with_ratio(cash_ratio=1.0)

# 使用25%现金，并指定价格
self.buy_with_ratio(cash_ratio=0.25, price=35.0)
```

### 2.3 sell_with_ratio()

按持仓比例卖出的便捷方法。

```python
def sell_with_ratio(position_ratio: float = 1.0, **kwargs):
```

**示例**：
```python
# 卖出50%持仓
self.sell_with_ratio(position_ratio=0.5)

# 全部卖出（等同于 close()）
self.sell_with_ratio(position_ratio=1.0)

# 卖出30%持仓，并指定价格
self.sell_with_ratio(position_ratio=0.3, price=36.0)
```

---

## 三、完整示例

### 3.1 RSI 策略示例

```python
class RSIStrategy(BaseStrategy):
    params = (
        ('rsi_period', 14),
        ('rsi_low', 30),
        ('rsi_high', 70),
        ('buy_ratio', 0.5),    # 使用50%现金买入
        ('sell_ratio', 0.5),   # 卖出50%持仓
    )
    
    def __init__(self):
        super().__init__()
        self.rsi = bt.indicators.RSI(self.data.close, period=self.params.rsi_period)
    
    def next(self):
        if self.order:
            return
        
        # 超卖：使用50%现金买入
        if self.rsi[0] < self.params.rsi_low and not self.position:
            self.buy_with_ratio(cash_ratio=self.params.buy_ratio)
        
        # 超买：卖出50%持仓
        elif self.rsi[0] > self.params.rsi_high and self.position:
            self.sell_with_ratio(position_ratio=self.params.sell_ratio)
```

### 3.2 分批建仓策略

```python
class GradualEntryStrategy(BaseStrategy):
    def next(self):
        if self.order:
            return
        
        # 第一次买入：使用30%现金
        if not self.position:
            size = self.calculate_position_size(cash_ratio=0.3)
            if size > 0:
                self.buy(size=size)
        
        # 加仓：再使用30%现金
        elif self.position.size < 1000:  # 持仓少于1000股时
            size = self.calculate_position_size(cash_ratio=0.3)
            if size > 0:
                self.buy(size=size)
        
        # 减仓：卖出30%持仓
        elif self.position.size > 2000:  # 持仓超过2000股时
            size = self.calculate_position_size(position_ratio=0.3)
            if size > 0:
                self.sell(size=size)
```

### 3.3 固定金额策略

```python
class FixedAmountStrategy(BaseStrategy):
    params = (
        ('buy_amount', 10000),  # 每次买入金额（元）
    )
    
    def next(self):
        if self.order:
            return
        
        # 计算固定金额对应的股数
        price = self.get_current_price()
        target_size = int(self.params.buy_amount / price)
        
        # 按最小交易单位取整
        size = (target_size // 100) * 100
        
        if size > 0:
            self.buy(size=size)
```

### 3.4 动态仓位管理

```python
class DynamicPositionStrategy(BaseStrategy):
    def next(self):
        if self.order:
            return
        
        # 根据市场情况动态调整仓位
        df = self.get_full_dataframe()
        volatility = df['close'].tail(20).std()
        avg_volatility = df['close'].tail(60).std()
        
        # 波动率低时，增加仓位
        if volatility < avg_volatility * 0.8:
            cash_ratio = 0.8  # 使用80%现金
        # 波动率高时，减少仓位
        elif volatility > avg_volatility * 1.2:
            cash_ratio = 0.3  # 只使用30%现金
        else:
            cash_ratio = 0.5  # 使用50%现金
        
        if 买入条件:
            self.buy_with_ratio(cash_ratio=cash_ratio)
```

---

## 四、最佳实践

### 4.1 仓位比例选择

```python
# ✅ 推荐：使用参数化配置
params = (
    ('buy_ratio', 0.5),   # 可调整
    ('sell_ratio', 0.5),
)

# ❌ 避免：硬编码
self.buy_with_ratio(cash_ratio=0.5)  # 难以调整
```

### 4.2 检查数量有效性

```python
# ✅ 推荐：检查数量
size = self.calculate_position_size(cash_ratio=0.5)
if size > 0:
    self.buy(size=size)

# ❌ 避免：不检查
self.buy_with_ratio(cash_ratio=0.5)  # 可能买入0股
```

### 4.3 最小交易单位

```python
# A股最小交易单位是100股（1手）
# calculate_position_size 会自动处理

# 如果计算结果是 150 股，会取整为 100 股
# 如果计算结果是 250 股，会取整为 200 股
```

### 4.4 资金管理

```python
# ✅ 推荐：保留部分现金
self.buy_with_ratio(cash_ratio=0.8)  # 保留20%现金

# ❌ 避免：全部投入
self.buy_with_ratio(cash_ratio=1.0)  # 没有缓冲资金
```

---

## 五、常见场景

### 5.1 全仓买入/卖出

```python
# 全仓买入
self.buy_with_ratio(cash_ratio=1.0)

# 全仓卖出
self.sell_with_ratio(position_ratio=1.0)
# 或使用
self.close()
```

### 5.2 半仓操作

```python
# 半仓买入
self.buy_with_ratio(cash_ratio=0.5)

# 半仓卖出
self.sell_with_ratio(position_ratio=0.5)
```

### 5.3 分批建仓

```python
# 第一次：30%
if not self.position:
    self.buy_with_ratio(cash_ratio=0.3)

# 第二次：再30%
elif self.position.size < 1000:
    self.buy_with_ratio(cash_ratio=0.3)

# 第三次：再30%
elif self.position.size < 2000:
    self.buy_with_ratio(cash_ratio=0.3)
```

### 5.4 分批减仓

```python
# 第一次：卖出30%
if self.position.size > 1000:
    self.sell_with_ratio(position_ratio=0.3)

# 第二次：再卖出30%
elif self.position.size > 500:
    self.sell_with_ratio(position_ratio=0.3)
```

---

## 六、注意事项

1. **最小交易单位**：A股最小交易单位是100股，会自动取整
2. **现金不足**：如果现金不足，`calculate_position_size` 会返回0
3. **持仓不足**：如果持仓不足，卖出数量会为0
4. **价格检查**：确保价格有效（> 0）再计算数量
5. **订单状态**：下单前检查 `self.order` 状态

---

## 七、总结

- ✅ 使用 `calculate_position_size()` 计算数量
- ✅ 使用 `buy_with_ratio()` 和 `sell_with_ratio()` 简化代码
- ✅ 通过参数化配置仓位比例
- ✅ 检查数量有效性再下单
- ✅ 合理管理资金，保留缓冲

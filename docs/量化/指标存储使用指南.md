# 指标存储使用指南

## 概述

策略基类 `BaseStrategy` 提供了完整的数据获取和指标存储功能，支持：
1. 获取完整的股票历史数据（DataFrame）
2. 存储自定义指标（如筹码峰等）
3. 支持历史指标和当前指标两种存储方式
4. 随时获取已存储的指标

---

## 一、获取完整数据

### 1.1 获取所有历史数据

```python
class MyStrategy(BaseStrategy):
    def next(self):
        # 方法1：获取完整 DataFrame
        df = self.get_full_dataframe()
        
        # 方法2：别名方法（功能相同）
        df = self.get_all_data()
        
        # DataFrame 包含以下列：
        # - datetime: 日期时间
        # - open, high, low, close: OHLC 价格
        # - volume: 成交量
        # 索引为日期（date）
```

### 1.2 DataFrame 结构

```python
df = self.get_full_dataframe()

# 查看数据结构
print(df.head())
print(df.columns)  # ['datetime', 'open', 'high', 'low', 'close', 'volume']
print(df.index)    # DatetimeIndex (日期索引)

# 访问数据
recent_data = df.tail(60)  # 最近60天数据
all_prices = df['close']   # 所有收盘价
```

---

## 二、指标存储

### 2.1 存储当前指标

**适用场景**：只需要当前值，不需要历史记录

```python
def next(self):
    # 计算指标
    chip_peak = self.calculate_chip_peak()
    
    # 存储当前指标（不按日期）
    self.set_indicator('chip_peak', chip_peak)
    
    # 获取指标
    chip_peak = self.get_indicator('chip_peak')
```

### 2.2 存储历史指标

**适用场景**：需要保留历史记录，可以回溯查看

```python
def next(self):
    # 计算指标
    chip_peak = self.calculate_chip_peak()
    current_date = self.data.datetime.date(0)
    
    # 存储历史指标（按日期）
    self.set_indicator('chip_peak_history', chip_peak, date=current_date)
    
    # 获取指定日期的指标
    yesterday_chip = self.get_indicator('chip_peak_history', date=yesterday_date)
    
    # 获取所有历史指标
    all_history = self.get_indicator_history('chip_peak_history')
    # 返回: {date1: value1, date2: value2, ...}
```

---

## 三、指标操作

### 3.1 设置指标

```python
# 存储简单值
self.set_indicator('rsi', 65.5)
self.set_indicator('rsi', 65.5, date=current_date)  # 历史指标

# 存储复杂对象
chip_peak = {
    'price': 35.5,
    'volume': 1000,
    'distribution': [0.1, 0.2, 0.3, 0.2, 0.2]
}
self.set_indicator('chip_peak', chip_peak)
self.set_indicator('chip_peak', chip_peak, date=current_date)  # 历史指标
```

### 3.2 获取指标

```python
# 获取当前指标
rsi = self.get_indicator('rsi')
chip_peak = self.get_indicator('chip_peak')

# 获取历史指标（指定日期）
rsi_yesterday = self.get_indicator('rsi', date=yesterday_date)

# 获取默认值（如果指标不存在）
rsi = self.get_indicator('rsi', default=50.0)
```

### 3.3 获取指标历史

```python
# 获取所有历史值
chip_history = self.get_indicator_history('chip_peak_history')
# 返回: {date1: value1, date2: value2, ...}

# 遍历历史指标
for date, value in chip_history.items():
    print(f"{date}: {value}")
```

### 3.4 检查和管理指标

```python
# 检查指标是否存在
if self.has_indicator('chip_peak'):
    chip_peak = self.get_indicator('chip_peak')

# 列出所有指标
all_indicators = self.list_indicators()
# 返回: ['chip_peak', 'rsi', 'macd', ...]

# 清除指标
self.clear_indicator('chip_peak')  # 清除指定指标
self.clear_indicator()             # 清除所有指标
```

---

## 四、完整示例

### 4.1 筹码峰计算和存储

```python
class ChipPeakStrategy(BaseStrategy):
    def __init__(self):
        super().__init__()
    
    def calculate_chip_peak(self, df: pd.DataFrame, lookback: int = 60) -> Dict:
        """计算筹码峰"""
        recent_df = df.tail(lookback)
        
        # 计算价格分布
        price_range = recent_df['high'].max() - recent_df['low'].min()
        avg_price = recent_df['close'].mean()
        total_volume = recent_df['volume'].sum()
        
        # 价格区间分布（示例）
        price_levels = []
        num_levels = 10
        price_min = recent_df['low'].min()
        price_max = recent_df['high'].max()
        level_size = (price_max - price_min) / num_levels
        
        for i in range(num_levels):
            level_price = price_min + i * level_size
            level_volume = recent_df[
                (recent_df['low'] <= level_price) & 
                (recent_df['high'] >= level_price)
            ]['volume'].sum()
            price_levels.append({
                'price': level_price,
                'volume': level_volume
            })
        
        return {
            'price_range': price_range,
            'avg_price': avg_price,
            'total_volume': total_volume,
            'price_levels': price_levels,
            'timestamp': self.data.datetime.datetime(0)
        }
    
    def next(self):
        # 1. 获取完整数据
        df = self.get_full_dataframe()
        
        if len(df) < 60:
            return
        
        # 2. 计算筹码峰
        chip_peak = self.calculate_chip_peak(df, lookback=60)
        
        # 3. 存储当前指标
        self.set_indicator('chip_peak', chip_peak)
        
        # 4. 存储历史指标
        current_date = self.data.datetime.date(0)
        self.set_indicator('chip_peak_history', chip_peak, date=current_date)
        
        # 5. 使用指标进行交易
        avg_price = chip_peak['avg_price']
        current_price = self.get_current_price()
        
        if current_price < avg_price * 0.95 and not self.position:
            self.buy()
        elif current_price > avg_price * 1.05 and self.position:
            self.sell()
```

### 4.2 多指标存储

```python
class MultiIndicatorStrategy(BaseStrategy):
    def next(self):
        df = self.get_all_data()
        current_date = self.data.datetime.date(0)
        
        # 计算多个指标
        rsi = self.calculate_rsi(df)
        macd = self.calculate_macd(df)
        chip_peak = self.calculate_chip_peak(df)
        momentum = self.calculate_momentum(df)
        
        # 存储所有指标（历史）
        self.set_indicator('rsi', rsi, date=current_date)
        self.set_indicator('macd', macd, date=current_date)
        self.set_indicator('chip_peak', chip_peak, date=current_date)
        self.set_indicator('momentum', momentum, date=current_date)
        
        # 获取历史指标进行比较
        rsi_history = self.get_indicator_history('rsi')
        if len(rsi_history) > 1:
            # 比较当前和之前的 RSI
            dates = sorted(rsi_history.keys())
            current_rsi = rsi_history[dates[-1]]
            previous_rsi = rsi_history[dates[-2]]
            
            if current_rsi > previous_rsi:
                # RSI 上升
                pass
```

---

## 五、最佳实践

### 5.1 指标命名规范

```python
# 推荐命名方式
self.set_indicator('chip_peak', ...)           # 当前指标
self.set_indicator('chip_peak_history', ...)  # 历史指标（加 _history 后缀）

# 或者使用前缀
self.set_indicator('indicator_rsi', ...)
self.set_indicator('indicator_macd', ...)
```

### 5.2 性能优化

```python
# ✅ 推荐：在需要时计算，避免重复计算
def next(self):
    if not self.has_indicator('chip_peak'):
        chip_peak = self.calculate_chip_peak()
        self.set_indicator('chip_peak', chip_peak)

# ❌ 避免：每次都重新计算（如果值不变）
def next(self):
    chip_peak = self.calculate_chip_peak()  # 每次都计算
    self.set_indicator('chip_peak', chip_peak)
```

### 5.3 内存管理

```python
# 如果历史指标太多，定期清理
def next(self):
    # 只保留最近100天的历史指标
    chip_history = self.get_indicator_history('chip_peak_history')
    if len(chip_history) > 100:
        # 删除最旧的数据
        oldest_dates = sorted(chip_history.keys())[:-100]
        for date in oldest_dates:
            del chip_history[date]
```

---

## 六、常见问题

### Q1: 如何判断指标是历史格式还是当前格式？

**A**: 使用 `get_indicator_history()` 方法，如果返回非空字典，则是历史格式。

```python
history = self.get_indicator_history('chip_peak')
if history:
    # 是历史格式
    pass
else:
    # 是当前格式
    pass
```

### Q2: 可以存储什么类型的指标值？

**A**: 可以存储任意类型：数值、字符串、列表、字典、对象等。

```python
self.set_indicator('number', 100)
self.set_indicator('string', 'value')
self.set_indicator('list', [1, 2, 3])
self.set_indicator('dict', {'key': 'value'})
self.set_indicator('object', MyObject())
```

### Q3: 如何将当前指标转换为历史指标？

**A**: 重新存储时指定日期即可。

```python
# 之前存储为当前指标
self.set_indicator('chip_peak', value)

# 转换为历史指标
current_date = self.data.datetime.date(0)
self.set_indicator('chip_peak', value, date=current_date)
```

---

## 七、总结

- ✅ 使用 `get_full_dataframe()` 获取完整历史数据
- ✅ 使用 `set_indicator()` 存储指标（支持历史格式）
- ✅ 使用 `get_indicator()` 获取指标
- ✅ 使用 `get_indicator_history()` 获取历史记录
- ✅ 合理使用当前指标和历史指标，平衡性能和需求

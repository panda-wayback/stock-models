"""
热力学参数计算模块
提供热力学参数（炉温、铁块温度、导热系数、筹码峰）的计算接口

核心概念：
- 所有热力学参数都在本模块计算，包括筹码峰（燃料）
- 每个参数都是根据上一个参数进行计算的（状态依赖）
"""
from typing import Dict, Optional
from abc import ABC, abstractmethod
import pandas as pd
from model.backtrader.strategy.thermodynamic.chip_peak import ChipPeak


class ThermalParamsCalculator(ABC):
    """
    热力学参数计算接口
    
    实现此接口以提供自定义的热力学参数计算算法
    
    重要概念：
    - 所有热力学参数都在本接口中计算，包括筹码峰（燃料）
    - 每个参数都是根据上一个参数进行计算的（状态依赖）
    - 这是一个动态演变的过程
    """
    
    @abstractmethod
    def calculate(
        self,
        df: pd.DataFrame,
        previous_params: Optional[Dict] = None,
        price_step: float = 0.01
    ) -> Dict:
        """
        计算热力学核心参数（状态依赖计算）
        
        参数:
        - df: 完整历史数据 DataFrame，必须包含以下列：
            - 'open': 开盘价（每个时间段的开盘价格）
            - 'high': 最高价（每个时间段的最高价格）
            - 'low': 最低价（每个时间段的最低价格）
            - 'close': 收盘价（每个时间段的收盘价格）
            - 'volume': 成交量（每个时间段的成交数量，单位：手或股）
            
            数据说明：
            - 传入所有可用的历史数据（完整数据集）
            - 可以是分时数据（5分钟、15分钟、30分钟、60分钟等）
            - 可以是日线数据
            - 每行代表一个时间段（一个K线）
            - 计算函数内部按需使用（可以使用最近1天、2天、3天等）
        - previous_params: 上一个状态的热力学参数（必需，首次计算时传入空字典或None）
            {
                'temperature': 上一个炉温
                'iron_temperature': 上一个铁块温度
                'thermal_conductivity': 上一个导热系数
                'chip_peak': 上一个筹码峰（ChipPeak 对象或字典）
            }
        - price_step: 价格步长（用于计算筹码峰）
            作用：每个价格区间的宽度（单位：元）
            例如：
                - price_step=0.01 表示每个区间代表0.01元（一分钱）
                - price_step=0.1 表示每个区间代表0.1元（一毛钱）
                - price_step=0.5 表示每个区间代表0.5元（五毛钱）
                - price_step=1.0 表示每个区间代表1.0元（一块钱）
            说明：
                - 价格区间是动态的，根据价格范围和 price_step 自动计算区间数量
                - 例如：价格范围 4.5-5.5，price_step=0.01，则会有100个区间
                - 每个区间对应一个价格点（区间中心）和一个筹码量
            推荐值：
                - 低价股（<10元）：price_step=0.01（一分钱，默认值）
                - 中价股（10-50元）：price_step=0.01 或 0.1
                - 高价股（>50元）：price_step=0.1 或 0.5
            注意：
                - 默认值 0.01（一分钱）适合大多数A股
                - 对于5块钱的股票，0.01（一分钱）比0.1（一毛钱）更合适
            
            计算方式推荐（区间合并法）：
            ============================================
            推荐使用"价格步长 + 区间合并"的方式计算筹码峰，这是最精确的方法：
            
            1. 使用 price_step 定义细粒度价格区间（如 0.01元一个区间）
            2. 对于每个K线，将其成交量按比例分配到 [low, high] 价格范围内的所有细粒度区间
            3. 这样更准确地反映筹码的真实分布，而不是简单按收盘价分配
            
            优势：
            - 更准确：考虑了K线的价格波动范围，而不是单一价格点
            - 更真实：反映了成交可能发生在 [low, high] 任何位置的事实
            - 更平滑：避免了按收盘价分配导致的分布突变
        
        返回:
        参数字典：
        {
            'temperature': 炉温 T（当前股价）- 根据上一个炉温计算
            'iron_temperature': 铁块温度 VWAP（成交均价）- 根据上一个铁块温度计算
            'thermal_conductivity': 导热系数 λ（单位成交量带来的涨幅）- 根据上一个导热系数计算
            'chip_peak': 筹码峰（燃料）- ChipPeak 对象 - 根据上一个筹码峰计算
        }
        
        重要：
        - 所有四个参数都是根据上一个状态计算的（状态依赖）
        - df 传入所有历史数据，计算函数内部按需使用（可以使用最近1天、2天、3天等）
        - 根据传入的数据和上一个状态，计算出新的参数
        - 如果 previous_params 为 None 或空字典，表示首次计算，需要初始化
        """
        pass
